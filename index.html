<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BDI Analysis</title>
  <!-- DataTables and Select2 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filters select {
      width: 180px;
    }
    .access-tag {
      background-color: #5BB1A9;
      color: white;
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 4px;
    }
    .download-btn {
      background-color: #F4A020;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
    }
    table.dataTable thead th {
      background-color: #000;
      color: white;
    }
    td {
      font-size: 13px;
    }
    .select2-container {
      min-width: 180px;
    }
  </style>
</head>
<body>
  <h2>BDI Analysis</h2>
  <div class="filters">
    <select id="yearFilter" multiple></select>
    <select id="locationFilter" multiple></select>
    <select id="typeFilter" multiple></select>
    <select id="accessFilter" multiple></select>
    <select id="focusFilter" multiple></select>
    <select id="actorFilter" multiple></select>
    <input type="text" id="pdfSearch" placeholder="Search text in PDFs" style="padding: 5px; width: 180px;" />
  </div>
  <table id="alertsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Location</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    const SHEET_ID = '1OiEVshjY2Dg1ACtVS-Jcp2LXF1qWepb8shAUNlXrOmc';
    const SHEET_NAME = 'Full Card Catalog [DO NOT FILTER]';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    let rawData = [];

    function formatDate(dateString) {
      if (!dateString) return "";
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      return date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
    }

    function populateDropdown(id, values) {
      const select = $(`#${id}`);
      const uniqueValues = [...new Set(values.filter(Boolean))].sort();
      select.empty();
      uniqueValues.forEach(val => {
        const option = new Option(val, val, false, false);
        select.append(option);
      });
      select.select2({
        placeholder: `Select ${id.replace("Filter", "")}`,
        allowClear: true
      });
    }

    function applyFilters() {
      const year = $('#yearFilter').val() || [];
      const loc = $('#locationFilter').val() || [];
      const type = $('#typeFilter').val() || [];
      const access = $('#accessFilter').val() || [];
      const focus = $('#focusFilter').val() || [];
      const actors = $('#actorFilter').val() || [];
      const textSearch = $('#pdfSearch').val().toLowerCase();

      const filtered = rawData.filter(item => {
        return (!year.length || year.includes(item["Year"])) &&
               (!loc.length || loc.includes(item["Location"])) &&
               (!type.length || type.includes(item["Document Type"])) &&
               (!access.length || access.includes(item["Access"])) &&
               (!focus.length || focus.includes(item["Focus Area"])) &&
               (!actors.length || actors.includes(item["Actors"])) &&
               (!textSearch || (item["pdfText"] || "").toLowerCase().includes(textSearch));
      });
      renderTable(filtered);
    }

    function renderTable(data) {
      const tableBody = document.querySelector("#alertsTable tbody");
      tableBody.innerHTML = "";
      data.sort((a, b) => new Date(b["Date (YYYY-MM-DD)"]) - new Date(a["Date (YYYY-MM-DD)"]));
      data.forEach(item => {
        const row = document.createElement("tr");
        const date = formatDate(item["Date (YYYY-MM-DD)"]);
        const title = `
          <strong>${item["Title"]}</strong><br/>
          <span class='access-tag'>${item["Access"]}</span><br/>
          ${item["Description"] || ""}
        `;
        const docType = item["Document Type"] || "";
        const location = item["Location"] || "";
        const download = item["Download [Internal]"]
          ? `<a href="${item["Download [Internal]"]}" class="download-btn" target="_blank">Download</a>`
          : "";
        row.innerHTML = `
          <td>${date}</td>
          <td>${title}</td>
          <td>${docType}</td>
          <td>${location}</td>
          <td>${download}</td>
        `;
        tableBody.appendChild(row);
      });

      if ($.fn.dataTable.isDataTable("#alertsTable")) {
        $('#alertsTable').DataTable().destroy();
      }

      $('#alertsTable').DataTable({
        pageLength: 25,
        order: [[0, 'desc']],
        dom: 'lrtip' // hide default search bar
      });
    }

    $(document).ready(function () {
      $.getJSON("https://script.google.com/a/macros/princeton.edu/s/AKfycbwW6RsaSUpsdXOX5OGI781JiWd3EGePA_6P6ctfUSQbC86XReS-Lrf9GWfBic3CSA1M/exec", function (data) {
        rawData = data;
        populateDropdown("yearFilter", data.map(d => d["Year"]));
        populateDropdown("locationFilter", data.map(d => d["Location"]));
        populateDropdown("typeFilter", data.map(d => d["Document Type"]));
        populateDropdown("accessFilter", data.map(d => d["Access"]));
        populateDropdown("focusFilter", data.map(d => d["Focus Area"]));
        populateDropdown("actorFilter", data.map(d => d["Actors"]));
        renderTable(data);
      });

      $(".filters select").on("change", applyFilters);
      $("#pdfSearch").on("keyup", applyFilters);
    });
  </script>
</body>
</html>
